{% extends "base.html" %}
{% load static %}

{% block title %}{{ course.title }} | ê°•ì˜ì‹¤{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/course_room.css' %}">
{% endblock %}

{% block content %}
<div class="course-room-container">

  <aside class="sidebar">
    <div class="course-info-box">
      <div class="course-title">{{ course.title }}</div>
      <div class="course-instructor">ğŸ‘¨â€ğŸ« {{ course.instructor.name }}</div>
    </div>

    <ul class="sidebar-menu">
      <li><a onclick="showTab('notices')" class="tab-link active" data-tab="notices">ğŸ“¢ ê³µì§€ì‚¬í•­</a></li>
      <li><a onclick="showTab('weekly')" class="tab-link" data-tab="weekly">ğŸ“š ì£¼ì°¨ë³„ ìë£Œ</a></li>
      <li><a onclick="showTab('assignments')" class="tab-link" data-tab="assignments">ğŸ“ ê³¼ì œ</a></li>
      <li><a onclick="showTab('questions')" class="tab-link" data-tab="questions">ğŸ’¬ ì§ˆë¬¸ ê²Œì‹œíŒ</a></li>
      <li><a href="{% url 'classroom:my_classroom' %}">â—€ ë‚´ ê°•ì˜ì‹¤ë¡œ</a></li>
    </ul>
  </aside>

  <main class="main-content">

    <div id="notices" class="tab-content active">
      <div class="section-header">
        <h2 class="section-title">ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
        {% if request.user == course.instructor or request.user.role == 'manager' %}
        <a href="{% url 'classroom:notice_create' course.course_id %}" class="btn-create">
          âœï¸ ê³µì§€ ì‘ì„±
        </a>
        {% endif %}
      </div>

      {% if notices %}
      <ul class="notice-list">
        {% for notice in notices %}
        <li class="notice-item" onclick="location.href='{% url 'classroom:notice_detail' notice.notice_id %}'">
          <div>
            {% if notice.is_pinned %}
            <span class="notice-badge">ê³µì§€</span>
            {% endif %}
            <span class="notice-title">{{ notice.title }}</span>
          </div>

          <div style="display: flex; gap: 10px; align-items: center;">
            <span class="notice-date">{{ notice.created_at|date:"Y.m.d" }}</span>
            {% if request.user == course.instructor or request.user.role == 'manager' %}
            <a href="{% url 'classroom:notice_update' notice.notice_id %}" onclick="event.stopPropagation();" class="btn-mini-edit">ìˆ˜ì •</a>
            <a href="{% url 'classroom:notice_delete' notice.notice_id %}" onclick="event.stopPropagation();" class="btn-mini-delete">ì‚­ì œ</a>
            {% endif %}
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="empty-state">
        <p>ğŸ“‹ ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% if request.user == course.instructor or request.user.role == 'manager' %}
        <a href="{% url 'classroom:notice_create' course.course_id %}">ì²« ê³µì§€ ì‘ì„±í•˜ê¸°</a>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <div id="weekly" class="tab-content">
      <div class="section-header">
        <h2 class="section-title">ğŸ“š ì£¼ì°¨ë³„ ê°•ì˜ ìë£Œ</h2>
        {% if request.user == course.instructor or request.user.role == 'manager' %}
        <a href="{% url 'classroom:weekly_create' course.course_id %}" class="btn-create">
          ğŸ“¤ ìë£Œ ì—…ë¡œë“œ
        </a>
        {% endif %}
      </div>

      {% if weekly_contents %}
      <div class="week-grid">
        {% for content in weekly_contents %}
        <a href="{% url 'classroom:weekly_detail' content.content_id %}" class="week-card">
          <div class="week-number">{{ content.week_number }}ì£¼ì°¨</div>
          <div class="week-title">{{ content.title }}</div>
          <p class="week-desc">{{ content.description|truncatewords:20 }}</p>
          <div class="week-actions">
            {% if content.file %}<span class="btn-download">ğŸ“¥ ìë£Œ ë‹¤ìš´ë¡œë“œ</span>{% endif %}
            {% if content.video_url %}<span class="btn-video">â–¶ï¸ ë™ì˜ìƒ</span>{% endif %}
          </div>
        </a>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <p>ğŸ“š ë“±ë¡ëœ ê°•ì˜ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
      {% endif %}
    </div>

    <div id="assignments" class="tab-content">
      <div class="section-header">
        <h2 class="section-title">ğŸ“ ê³¼ì œ</h2>
        {% if request.user == course.instructor or request.user.role == 'manager' %}
        <a href="{% url 'classroom:assignment_create' course.course_id %}" class="btn-create">
          â• ê³¼ì œ ë“±ë¡
        </a>
        {% endif %}
      </div>

      {% if assignments %}
      <div class="assignment-list">
        {% for assignment in assignments %}
        <div class="assignment-card">
          <div class="assignment-info">
            <div class="assignment-title">
              <a href="{% url 'classroom:assignment_detail' assignment.assignment_id %}">{{ assignment.title }}</a>
            </div>
            <div class="assignment-meta">
              ğŸ“… ë§ˆê°: {{ assignment.due_date|date:"Y.m.d H:i" }} | ğŸ’¯ ë°°ì : {{ assignment.max_score }}ì 
            </div>
          </div>

          <div style="text-align:right;">
            {% if request.user != course.instructor and request.user.role != 'manager' %}
              {% if assignment.assignment_id in submitted_ids %}
              <span class="btn-submitted">âœ… ì œì¶œ ì™„ë£Œ</span>
              {% else %}
              <a href="{% url 'classroom:submit_assignment' assignment.assignment_id %}" class="btn-submit">ğŸ“¤ ì œì¶œí•˜ê¸°</a>
              {% endif %}
            {% endif %}

            {% if request.user == course.instructor or request.user.role == 'manager' %}
            <div class="admin-actions">
              <a href="{% url 'classroom:submission_list' assignment.assignment_id %}" class="btn-manage" style="background:#6c757d;">ì œì¶œ ëª©ë¡</a>
              <a href="{% url 'classroom:assignment_update' assignment.assignment_id %}" class="btn-manage" style="background:#0d6efd;">âœï¸ ìˆ˜ì •</a>
              <a href="{% url 'classroom:assignment_delete' assignment.assignment_id %}" class="btn-manage" style="background:#dc3545;">ğŸ—‘ ì‚­ì œ</a>
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <p>ğŸ“ ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% if request.user == course.instructor or request.user.role == 'manager' %}
        <a href="{% url 'classroom:assignment_create' course.course_id %}">ì²« ê³¼ì œ ë“±ë¡í•˜ê¸°</a>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <div id="questions" class="tab-content">
      <div class="section-header">
        <h2 class="section-title">ğŸ’¬ ì§ˆë¬¸ ê²Œì‹œíŒ</h2>
        <a href="{% url 'classroom:question_create' course.course_id %}" class="btn-create">âœï¸ ì§ˆë¬¸í•˜ê¸°</a>
      </div>

      {% if questions %}
      <div class="question-list">
        {% for question in questions %}
        <a href="{% url 'classroom:question_detail' question.question_id %}" class="question-card">
          <div class="question-header">
            <div>
              <span class="question-title-text">{{ question.title }}</span>
              {% if question.is_resolved %}
              <span class="resolved-badge">âœ… í•´ê²°ë¨</span>
              {% endif %}
            </div>
            <span class="notice-date">{{ question.created_at|date:"Y.m.d" }}</span>
          </div>
          <div class="question-content">{{ question.content|truncatewords:20 }}</div>
          <div class="question-meta">
            <span>ğŸ‘¤ {{ question.author.name }}</span>
            <span>ğŸ’¬ ë‹µë³€ {{ question.answers.count }}ê°œ</span>
          </div>
        </a>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <p>ğŸ’¬ ë“±ë¡ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <a href="{% url 'classroom:question_create' course.course_id %}">ì²« ì§ˆë¬¸ ì‘ì„±í•˜ê¸°</a>
      </div>
      {% endif %}
    </div>

  </main>

</div>

<script>
function showTab(tabName) {
  const allTabs = document.querySelectorAll('.tab-content');
  allTabs.forEach(tab => { tab.classList.remove('active'); });
  const allLinks = document.querySelectorAll('.tab-link');
  allLinks.forEach(link => { link.classList.remove('active'); });
  document.getElementById(tabName).classList.add('active');
  const selectedLink = document.querySelector(`[data-tab="${tabName}"]`);
  if (selectedLink) { selectedLink.classList.add('active'); }
}
</script>
{% endblock %}