{% extends "base.html" %}
{% load static %}

{% block title %}ë‚´ ì •ë³´ ìˆ˜ì •{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mypage.css' %}?v=20251128_2">

<style>
  /* === 1. ì‚¬ì´ë“œë°” ë©”ë‰´ ìœ„ì¹˜ ê³ ì • (ì´ì „ í˜ì´ì§€ë“¤ê³¼ í†µì¼) === */
  #menuItem1, #menuItem2 {
    position: absolute;
    left: 238px;
    font-size: 20px;
    color: #000;
    white-space: nowrap;
    text-decoration: none;
  }
  #menuItem1 { top: calc(var(--content-top, 0px) + 343px); } /* ë‚´ ì •ë³´ */
  #menuItem2 { top: calc(var(--content-top, 0px) + 399px); } /* DIMC ì•„ì¹´ì´ë¸Œ */
  #menuItem3 { top: calc(var(--content-top, 0px) + 455px); } /* DIMC ì—…ë¡œë“œ ë‚´ì—­ */

  /* === 2. ë‚´ ì •ë³´ ìˆ˜ì • ì¹´ë“œ ë ˆì´ì•„ì›ƒ === */
  #infoBox {
    position: absolute;
    left: 490px;
    top: 321px;
    width: 685px;
    background: #fff;
    border: 1px solid #CBC6C6; /* í…Œë‘ë¦¬ ì¶”ê°€ */
    border-radius: 10px;
    padding: 30px;
    box-sizing: border-box;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
  }

  .card-title {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #000;
  }

  /* === 3. í¼ ë‚´ë¶€ í–‰(Row) ìŠ¤íƒ€ì¼ === */
  .panel {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .row {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
    min-height: 50px;
  }

  .lbl {
    width: 120px;
    font-weight: 600;
    color: #333;
    flex-shrink: 0;
  }

  .main {
    flex: 1;
    display: flex;
    align-items: center;
  }

  /* === 4. í•µì‹¬: ë³´ê¸°/ìˆ˜ì • ëª¨ë“œ ì „í™˜ ë¡œì§ === */
  /* ê¸°ë³¸ ìƒíƒœ: ì…ë ¥ì°½(.inputs) ìˆ¨ê¹€, í…ìŠ¤íŠ¸(.masked) ë³´ì„ */
  .row .inputs { display: none; }
  .row .masked { display: block; font-size: 15px; color: #555; }
  .row input.text { display: none; } /* ì¼ë°˜ í…ìŠ¤íŠ¸ ì¸í’‹ë„ ê¸°ë³¸ ìˆ¨ê¹€ */

  /* ìˆ˜ì • ìƒíƒœ(.editing): ì…ë ¥ì°½ ë³´ì„, í…ìŠ¤íŠ¸ ìˆ¨ê¹€ */
  .row.editing .inputs { display: flex; align-items: center; gap: 5px; }
  .row.editing .masked { display: none; }
  .row.editing input.text { display: block; }

  /* === 5. ì…ë ¥ì°½ ë””í…Œì¼ === */
  .inputs .ph, .inputs .yr, .inputs .mo, .inputs .dy {
    height: 32px;
    border: 1px solid #ccc;
    border-radius: 4px;
    text-align: center;
    font-size: 14px;
  }

  /* ğŸ‘‡ [ìˆ˜ì •ë¨] 50px -> 70pxë¡œ ë³€ê²½í•˜ì—¬ 4ìë¦¬ ìˆ«ìê°€ ì˜ ë³´ì´ê²Œ í•¨ */
  .inputs .ph { width: 70px; }

  .inputs .yr { width: 60px; }
  .inputs .mo, .inputs .dy { width: 40px; }

  .sep { margin: 0 4px; font-weight: bold; color: #999; }

  input.text {
    height: 32px;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 0 10px;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
  }
  input.text.wide { max-width: 300px; }

  /* ì´ë©”ì¼ì€ disabled ìƒíƒœ ìŠ¤íƒ€ì¼ */
  .row-email input.text {
    display: block !important; /* ì´ë©”ì¼ì€ í•­ìƒ input í˜•íƒœë¡œ ë³´ì—¬ì£¼ë˜ */
    background: #f9f9f9;
    border: none;
    color: #777;
  }
  .row-email .masked { display: none !important; }

  /* === 6. ë²„íŠ¼ ìŠ¤íƒ€ì¼ === */
  .btn-mini {
    padding: 5px 12px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    margin-left: 10px;
  }
  .btn-mini:hover { background: #f0f0f0; }
  .btn-mini:disabled { opacity: 0.5; cursor: default; }

  .form-actions {
    margin-top: 30px;
    text-align: center;
  }

  .btn-save {
    background: #5651E9;
    color: #fff;
    border: none;
    padding: 10px 40px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
  }
  .btn-save:hover { opacity: 0.9; }

  /* í™”ë©´ì—ì„œ ìˆ¨ê¸°ê¸° (ìŠ¤í¬ë¦° ë¦¬ë”ìš© or ë°ì´í„° ì „ì†¡ìš©) */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    border: 0;
  }
</style>
{% endblock %}

{% block content %}
<div id="canvas" role="main" aria-labelledby="pageTitle">
  <div id="bgMypage"></div>
  <h1 id="pageTitle">ë§ˆì´í˜ì´ì§€</h1>

  <div id="menuTitle">ë©”ë‰´</div>
  <div id="menuBox"></div>
  <div id="menuLine1"></div>
  <div id="menuLine2"></div>

  <a id="menuItem1" href="{% url 'user:mypage' %}">ë‚´ ì •ë³´</a>
  <a id="menuItem2" href="{% url 'user:DIMC_archive' %}">DIMC ì•„ì¹´ì´ë¸Œ</a>
  <a id="menuItem3" href="{% url 'user:dimc_results' %}">DIMC ì—…ë¡œë“œ ë‚´ì—­</a>

  <div id="infoBox">
    <h2 class="card-title">ë‚´ ì •ë³´ ìˆ˜ì •</h2>

    <form id="editForm" method="post" novalidate>
      {% csrf_token %}
      <input type="hidden" name="name" value="{{ request.user.name|default_if_none:'' }}">

      <div class="panel">

        {# 1. ì—°ë½ì²˜ #}
        <div class="row row-phone">
          <label class="lbl">ì—°ë½ì²˜</label>
          <div class="main">
            <span class="masked">
              {% if request.user.phone_number %}
                {% with pn=request.user.phone_number|cut:"-" %}
                  {{ pn|slice:":3" }}-****-{{ pn|slice:"-4:" }}
                {% endwith %}
              {% else %}010-****-0000{% endif %}
            </span>

            <div class="inputs phone">
              <input type="text" inputmode="numeric" maxlength="3" class="ph" id="ph1">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="4" class="ph" id="ph2">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="4" class="ph" id="ph3">
            </div>
          </div>
          <button type="button" class="btn-mini js-edit" data-focus="#ph1">ìˆ˜ì •</button>

          <input type="tel" name="phone_number" id="phoneRaw" class="sr-only"
                 value="{{ request.user.phone_number|default_if_none:'' }}">
        </div>

        {# 2. ì´ë©”ì¼ (ìˆ˜ì • ë¶ˆê°€) #}
        <div class="row row-email">
          <label class="lbl">ì´ë©”ì¼(ì•„ì´ë””)</label>
          <div class="main">
            <input class="text" type="email" value="{{ request.user.email }}" disabled>
          </div>
          <button type="button" class="btn-mini" disabled style="opacity:0;">ìˆ˜ì •</button>
        </div>

        {# 3. ì£¼ì†Œ #}
        <div class="row row-addr">
          <label class="lbl">ì£¼ì†Œ</label>
          <div class="main">
            <span class="masked">
              {% if request.user.address %}
                {{ request.user.address|slice:":10" }}...
              {% else %}-{% endif %}
            </span>
            <input class="text wide" type="text" id="addr" name="address"
                   value="{{ request.user.address|default_if_none:'' }}"
                   placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.">
          </div>
          <button type="button" class="btn-mini js-edit" data-focus="#addr">ìˆ˜ì •</button>
        </div>

        {# 4. ìƒë…„ì›”ì¼ #}
        <div class="row row-birth">
          <label class="lbl">ìƒë…„ì›”ì¼</label>
          <div class="main">
            <span class="masked">
              {% if request.user.birthday %}
                {{ request.user.birthday|date:"Y-m-d" }}
              {% else %}YYYY-MM-DD{% endif %}
            </span>

            <div class="inputs birth" id="birthInputs">
              <input type="text" inputmode="numeric" maxlength="4" class="yr" id="by" placeholder="YYYY">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="2" class="mo" id="bm" placeholder="MM">
              <span class="sep">-</span>
              <input type="text" inputmode="numeric" maxlength="2" class="dy" id="bd" placeholder="DD">
            </div>
          </div>
          <button type="button" class="btn-mini js-edit" data-focus="#by">ìˆ˜ì •</button>

          <input type="hidden" name="birthday" id="birthRaw"
                 value="{% if request.user.birthday %}{{ request.user.birthday|date:'Y-m-d' }} 00:00:00{% endif %}">
        </div>

      </div>

      <div class="form-actions">
        <button type="submit" class="btn-save">ì €ì¥</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  // [A] "ìˆ˜ì •" ë²„íŠ¼ í´ë¦­ ì‹œ í´ë˜ìŠ¤(.editing) í† ê¸€
  const allRows = Array.from(document.querySelectorAll('#infoBox .row'));

  document.querySelectorAll('#infoBox .btn-mini.js-edit').forEach(btn => {
    btn.addEventListener('click', () => {
      const row = btn.closest('.row');
      if (!row) return;

      // ë‹¤ë¥¸ ì¤„ì€ ìˆ˜ì • ëª¨ë“œ í•´ì œ (í•œ ë²ˆì— í•œ ì¤„ë§Œ)
      allRows.forEach(r => { if (r !== row) r.classList.remove('editing'); });

      // í˜„ì¬ ì¤„ í† ê¸€
      row.classList.toggle('editing');

      // ìˆ˜ì • ëª¨ë“œê°€ ë˜ë©´ í•´ë‹¹ ì¸í’‹ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
      if (row.classList.contains('editing')) {
        const sel = btn.dataset.focus;
        if (sel) {
          const target = row.querySelector(sel);
          if (target) target.focus();
        }
      }
    });
  });

  // [B] ë°ì´í„° ì´ˆê¸°í™” ë° ì „ì†¡ ì¤€ë¹„
  const ph = ['ph1','ph2','ph3'].map(id => document.getElementById(id));
  const phoneRaw = document.getElementById('phoneRaw');

  const by = document.getElementById('by'),
        bm = document.getElementById('bm'),
        bd = document.getElementById('bd'),
        birthRaw = document.getElementById('birthRaw');

  // 1. ê¸°ì¡´ DB ê°’ì„ ìª¼ê°œì„œ ì¸í’‹ì¹¸ì— ë„£ì–´ë‘ê¸°
  if (phoneRaw && phoneRaw.value) {
    const parts = phoneRaw.value.trim().split('-');
    if (parts.length === 3) {
      if (ph[0]) ph[0].value = parts[0];
      if (ph[1]) ph[1].value = parts[1];
      if (ph[2]) ph[2].value = parts[2];
    }
  }
  if (birthRaw && birthRaw.value) {
    // YYYY-MM-DD í¬ë§· ê°€ì •
    const val = birthRaw.value.trim();
    // ë‚ ì§œë§Œ ì¶”ì¶œ (ì‹œê°„ ì œì™¸)
    const datePart = val.split(' ')[0];
    const m = datePart.split('-');

    if (m.length === 3) {
      if (by) by.value = m[0];
      if (bm) bm.value = m[1];
      if (bd) bd.value = m[2];
    }
  }

  // 2. ìˆ«ìë§Œ ì…ë ¥ë˜ë„ë¡ ê°•ì œ & ìë™ í¬ì»¤ìŠ¤ ì´ë™
  [ ...ph, by, bm, bd ].forEach(inp => {
    if (!inp) return;
    inp.addEventListener('input', e => {
      e.target.value = e.target.value.replace(/[^0-9]/g,''); // ìˆ«ìë§Œ

      const max = e.target.maxLength || 0;
      if (max && e.target.value.length >= max) {
        // ë‹¤ìŒ ì¹¸ìœ¼ë¡œ ì´ë™
        const order = [ ...ph, by, bm, bd ];
        const idx = order.indexOf(e.target);
        if (idx > -1 && order[idx+1]) order[idx+1].focus();
      }
    });
  });

  // 3. í¼ ì œì¶œ ì‹œ(submit) í©ì–´ì§„ ì¸í’‹ë“¤ì„ í•©ì³ì„œ hidden inputì— ë„£ê¸°
  document.getElementById('editForm').addEventListener('submit', () => {
    // ì „í™”ë²ˆí˜¸ ì¡°ë¦½
    if (ph[0] && ph[1] && ph[2]) {
      const p1 = ph[0].value.trim();
      const p2 = ph[1].value.trim();
      const p3 = ph[2].value.trim();
      // ê°’ì´ ë‹¤ ìˆì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
      if (p1 && p2 && p3) {
        phoneRaw.value = `${p1}-${p2}-${p3}`;
      }
    }

    // ìƒë…„ì›”ì¼ ì¡°ë¦½
    if (by && bm && bd) {
      const y = by.value.trim();
      const m = bm.value.trim().padStart(2,'0');
      const d = bd.value.trim().padStart(2,'0');

      if (y && m && d) {
        // Django DateTimeFieldì— ë§ê²Œ í¬ë§·
        birthRaw.value = `${y}-${m}-${d} 00:00:00`;
      }
    }
  });
})();
</script>
{% endblock %}