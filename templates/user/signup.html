{% extends 'base.html' %}
{% load static %}

{% block title %}회원가입{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/signup.css' %}">
{% endblock %}

{% block content %}
<section class="hero">
  <div class="hero-inner">
  </div>
</section>

<main class="card-wrap">
  <div class="card-inner">

    <section class="signup-card">
      <h2 class="card-title">회원가입</h2>

      <form method="post" action="{% url 'user:signup' %}">
        {% csrf_token %}
        
        {{ form.non_field_errors }}

        <div class="field col-2">
          <label for="id_email">아이디(이메일)</label>
          <div class="row-inline">
            {{ form.email }}
            <button type="button" id="check-email-btn" class="btn-aux">중복확인</button>
          </div>

          <div class="status-line">
            <span id="msg-err-email" class="msg err" style="display: none; color: #dc3545;">
              이미 사용중인 아이디(이메일)입니다.
            </span>
            <span id="msg-ok-email" class="msg ok" style="display: none; color: #28a745;">
              사용 가능한 아이디(이메일)입니다.
            </span>
          </div>

          {{ form.email.errors }}
        </div>

        <div class="field">
          <label for="id_password">비밀번호</label>
          {{ form.password }}
          <p class="help">비밀번호는 8~16자로 설정해야 하며, 영문·숫자·특수문자 조합을 권장합니다.</p>
          {{ form.password.errors }}
        </div>

        <div class="field">
          <label for="id_password_confirm">비밀번호 확인</label>
          {{ form.password_confirm }}
          <span id="msg-err-pw" class="msg err" style="display: none;">비밀번호가 일치하지 않습니다.</span>
          {{ form.password_confirm.errors }}
        </div>

        <div class="field">
          <label for="id_name">이름</label>
          {{ form.name }}
          {{ form.name.errors }}
        </div>

        <div class="field">
          <label for="id_birthday">생년월일</label>
          {{ form.birthday }}
          {{ form.birthday.errors }}
        </div>

        <div class="field col-2">
          <label for="id_phone_number">연락처(휴대폰)</label>
          {{ form.phone_number }}
          {{ form.phone_number.errors }}
        </div>

        <div class="field col-2">
          <label for="id_address">주소</label>
          {{ form.address }}
          {{ form.address.errors }}
        </div>

        <div class="field col-2">
          <label for="id_code">기관 인증코드</label>
          {{ form.code }}
          <span id="msg-err-code" class="msg err" style="display: none;">인증코드가 올바르지 않습니다.</span>
          <p class="help">
            소속 기관(학교/학원/센터) 담당자에게 발급받은 인증코드를 입력하세요.<br>
            올바른 인증코드를 입력해야 강사/매니저 권한이 부여됩니다.
          </p>
          {{ form.code.errors }}
        </div>

        <div class="cta">
          <button type="submit" class="btn-primary">회원가입</button>
        </div>
      </form>
    </section>

  </div>
</main>

<script>
  (function() {
    // 1. 요소 찾기
    const msgEmailErr = document.getElementById('msg-err-email');
    const msgEmailOk = document.getElementById('msg-ok-email');
    const msgPwErr = document.getElementById('msg-err-pw');
    const checkEmailBtn = document.getElementById('check-email-btn');
    const emailInput = document.getElementById('id_email');

    // 2. 중복확인 버튼 클릭 이벤트 (FormData 방식 사용)
    if (checkEmailBtn) {
      checkEmailBtn.addEventListener('click', function() {
        const email = emailInput.value.trim();

        if (!email) {
            alert("이메일을 입력해주세요.");
            emailInput.focus();
            return;
        }

        // CSRF 토큰
        const csrfTokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';

        // [중요] JSON 대신 FormData 객체 생성
        const formData = new FormData();
        formData.append('email', email);

        // 서버 전송
        fetch("{% url 'user:check_email' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
                // 주의: FormData 사용 시 'Content-Type': 'application/json'을 넣으면 안 됩니다.
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                // 400, 500 에러 처리
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // 결과에 따른 UI 처리
            if (data.is_duplicate) {
                // 중복됨
                msgEmailOk.style.display = 'none';
                msgEmailErr.style.display = 'block';
                emailInput.focus();
            } else {
                // 사용 가능
                msgEmailErr.style.display = 'none';
                msgEmailOk.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("중복 확인 중 오류가 발생했습니다.");
        });
      });
    }

    // 3. 비밀번호 확인 실시간 검사
    const pw1 = document.getElementById('id_password');
    const pw2 = document.getElementById('id_password_confirm');

    if (pw1 && pw2 && msgPwErr) {
        function checkPasswordMatch() {
            // 둘 다 값이 있을 때만 비교
            if (pw1.value && pw2.value) {
                if (pw1.value !== pw2.value) {
                    msgPwErr.style.display = 'block';
                } else {
                    msgPwErr.style.display = 'none';
                }
            } else {
                msgPwErr.style.display = 'none';
            }
        }
        pw1.addEventListener('keyup', checkPasswordMatch);
        pw2.addEventListener('keyup', checkPasswordMatch);
    }
  })();
</script>
{% endblock %}