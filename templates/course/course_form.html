{% extends "base.html" %}
{% load static %}

{% block title %}강의 등록 | DORO LMS{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/course_form.css' %}">
{% endblock %}

{% block content %}
<div class="form-container">
  <h1 class="form-title">{% if form.instance.pk %}강의 수정{% else %}강의 등록{% endif %}</h1>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      <strong>⚠️ 오류가 발생했습니다:</strong>
      <ul>
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="form-group">
      <label for="{{ form.title.id_for_label }}" class="required">{{ form.title.label }}</label>
      {{ form.title }}
      {% if form.title.errors %}
        <ul class="errorlist">
          {% for error in form.title.errors %}<li>{{ error }}</li>{% endfor %}
        </ul>
      {% endif %}
    </div>

    <div class="form-group">
      <label for="{{ form.description.id_for_label }}" class="required">{{ form.description.label }}</label>
      {{ form.description }}
      {% if form.description.errors %}
        <ul class="errorlist">
          {% for error in form.description.errors %}<li>{{ error }}</li>{% endfor %}
        </ul>
      {% endif %}
    </div>

    <div class="form-group">
      <label for="{{ form.image.id_for_label }}">{{ form.image.label }}</label>
      {{ form.image }}
      {% if form.image.errors %}
        <ul class="errorlist">
          {% for error in form.image.errors %}<li>{{ error }}</li>{% endfor %}
        </ul>
      {% endif %}

      {% if form.instance.image %}
      <div class="image-preview">
        <p style="font-size: 13px; color: #666; margin-top: 10px;">현재 이미지:</p>
        <img src="{{ form.instance.image.url }}" alt="현재 썸네일">
      </div>
      {% endif %}

      <div class="image-preview" id="newImagePreview" style="display: none;">
        <p style="font-size: 13px; color: #666; margin-top: 10px;">새 이미지 미리보기:</p>
        <img id="preview" src="" alt="미리보기">
      </div>
    </div>

    <div class="form-group">
      <label for="{{ form.category.id_for_label }}" class="required">{{ form.category.label }}</label>
      {{ form.category }}
      {% if form.category.errors %}
        <ul class="errorlist">
          {% for error in form.category.errors %}<li>{{ error }}</li>{% endfor %}
        </ul>
      {% endif %}
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="{{ form.weekday.id_for_label }}" class="required">{{ form.weekday.label }}</label>
        {{ form.weekday }}
        {% if form.weekday.errors %}
          <ul class="errorlist">
            {% for error in form.weekday.errors %}<li>{{ error }}</li>{% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ form.start_time.id_for_label }}" class="required">{{ form.start_time.label }}</label>
        {{ form.start_time }}
        {% if form.start_time.errors %}
          <ul class="errorlist">
            {% for error in form.start_time.errors %}<li>{{ error }}</li>{% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ form.end_time.id_for_label }}" class="required">{{ form.end_time.label }}</label>
        {{ form.end_time }}
        {% if form.end_time.errors %}
          <ul class="errorlist">
            {% for error in form.end_time.errors %}<li>{{ error }}</li>{% endfor %}
          </ul>
        {% endif %}
      </div>
    </div>

    <div class="form-row-2">
      <div class="form-group">
        <label for="{{ form.start_date.id_for_label }}" class="required">{{ form.start_date.label }}</label>
        {{ form.start_date }}
        {% if form.start_date.errors %}
          <ul class="errorlist">
            {% for error in form.start_date.errors %}<li>{{ error }}</li>{% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ form.end_date.id_for_label }}" class="required">{{ form.end_date.label }}</label>
        {{ form.end_date }}
        {% if form.end_date.errors %}
          <ul class="errorlist">
            {% for error in form.end_date.errors %}<li>{{ error }}</li>{% endfor %}
          </ul>
        {% endif %}
      </div>
    </div>

    <button type="submit" class="btn-submit">
      {% if form.instance.pk %}수정하기{% else %}등록하기{% endif %}
    </button>

    <a href="{% url 'course:course_list' %}" class="btn-cancel">취소</a>
  </form>
</div>

<script>
document.getElementById('id_image').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('preview').src = e.target.result;
      document.getElementById('newImagePreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
});
</script>
{% endblock %}