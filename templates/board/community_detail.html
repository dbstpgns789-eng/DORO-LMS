{% extends "base.html" %}
{% load static %}

{% block title %}{{ post.post_title }} | DORO LMS{% endblock %}

{% block content %}
<section class="hero">
  <div class="hero-inner">
  </div>
</section>

<main class="card-wrap">
  <div class="card-inner">

    <article style="max-width: 900px; margin: 0 auto;">

      <header style="border-bottom: 2px solid #dee2e6; padding-bottom: 20px; margin-bottom: 20px;">
        <h2 style="margin: 10px 0; font-size: 24px; font-weight: 600;">
          {% if not post.open %}
            <span style="color: #dc3545; font-size: 0.8em; vertical-align: middle;">ğŸ”’</span>
          {% endif %}
          {% if post.board %}
            <span style="color: #0d6efd; font-size: 0.8em; margin-right: 5px;">
              [{{ post.get_board_display|default:post.board }}]
            </span>
          {% endif %}
          {{ post.post_title }}
        </h2>
        <div style="display: flex; gap: 20px; color: #6c757d; font-size: 14px; margin-top: 15px;">
          <span>ğŸ‘¤ {{ post.author.name }}</span>
          <span>ğŸ“… {{ post.created_at|date:"Yë…„ mì›” dì¼ H:i" }}</span>
          <span>ğŸ‘ï¸ ì¡°íšŒìˆ˜ {{ post.view }}</span>
        </div>
      </header>

      <div style="line-height: 1.8; padding: 30px 0; min-height: 200px; white-space: pre-wrap;">{{ post.content }}</div>

      <div style="border-bottom: 1px solid #dee2e6; padding-bottom: 20px; margin-bottom: 40px; display: flex; justify-content: space-between; align-items: center;">
        <a href="{% url 'board:community_list' %}" style="display: inline-block; padding: 8px 16px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 5px; font-size: 14px;">
          â† ëª©ë¡ìœ¼ë¡œ
        </a>
        <div style="display: flex; gap: 8px;">
          {% if request.user == post.author %}
          <a href="{% url 'board:community_update' post.post_id %}" style="display: inline-block; padding: 8px 16px; background-color: #0d6efd; color: white; text-decoration: none; border-radius: 5px; font-size: 14px;">
            âœï¸ ìˆ˜ì •
          </a>
          {% endif %}
          {% if request.user == post.author or request.user.role == 'manager' %}
          <a href="{% url 'board:community_delete' post.post_id %}" style="display: inline-block; padding: 8px 16px; background-color: #dc3545; color: white; text-decoration: none; border-radius: 5px; font-size: 14px;">
            ğŸ—‘ï¸ ì‚­ì œ
          </a>
          {% endif %}
        </div>
      </div>

      <section class="comment-section" style="margin-top: 40px;">
        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 15px;">
          ëŒ“ê¸€ <span style="color: #0d6efd;">{{ active_count }}</span>
        </h3>

        <ul style="list-style: none; padding: 0; margin-bottom: 30px;">
          {% for comment in post.communitycomment_set.all %}
            {% if not comment.parent %}

            {% if not comment.is_deleted or comment.has_active_replies %}

            <li style="border-bottom: 1px solid #f1f3f5; padding: 15px 0;">
              {% if comment.is_deleted %}
                <div style="padding: 10px 0; color: #adb5bd; font-size: 14px; font-style: italic;">
                  ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤.
                </div>
              {% else %}
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                  <div>
                    <strong style="font-size: 14px; color: #212529; margin-right: 5px;">{{ comment.author.name }}</strong>
                    {% if comment.author == post.author %}
                      <span style="font-size: 11px; color: #0d6efd; background: #e7f5ff; padding: 2px 5px; border-radius: 4px; margin-right: 8px; font-weight: bold;">ì‘ì„±ì</span>
                    {% else %}
                      <span style="margin-right: 8px;"></span>
                    {% endif %}
                    <span style="font-size: 12px; color: #868e96;">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
                  </div>

                  <div style="display: flex; gap: 8px;">
                    {% if request.user.is_authenticated %}
                    <button onclick="toggleReplyForm('{{ comment.pk }}')"
                            style="background: none; border: none; color: #0d6efd; font-size: 12px; cursor: pointer; padding: 0;">
                      ë‹µê¸€
                    </button>
                    {% endif %}

                    {% if request.user == comment.author or request.user.role == 'manager' %}
                      <a href="{% url 'board:comment_delete' comment.pk %}"
                         onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                         style="font-size: 12px; color: #dc3545; text-decoration: none;">
                         ì‚­ì œ
                      </a>
                    {% endif %}
                  </div>
                </div>

                <div style="white-space: pre-wrap; color: #495057; font-size: 14px;">{{ comment.comment_content }}</div>

                <div id="reply-form-{{ comment.pk }}" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                  <form action="{% url 'board:comment_create' post.post_id %}" method="post" style="display: flex; gap: 10px;">
                    {% csrf_token %}
                    <input type="hidden" name="parent_id" value="{{ comment.pk }}">
                    <textarea name="comment_content" required placeholder="ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." rows="2"
                              style="flex: 1; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; resize: none; font-size: 13px;"></textarea>
                    <button type="submit" style="padding: 0 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">ë“±ë¡</button>
                  </form>
                </div>
              {% endif %}
            </li>

            {% for reply in comment.replies.all %}
              {% if not reply.is_deleted %}
              <li style="border-bottom: 1px solid #f1f3f5; padding: 15px 0 15px 40px; background-color: #fafafa;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                  <div style="display: flex; align-items: center;">
                    <span style="color: #adb5bd; margin-right: 8px;">â†³</span>
                    <strong style="font-size: 14px; color: #212529; margin-right: 5px;">{{ reply.author.name }}</strong>
                    {% if reply.author == post.author %}
                      <span style="font-size: 11px; color: #0d6efd; background: #e7f5ff; padding: 2px 5px; border-radius: 4px; margin-right: 8px; font-weight: bold;">ì‘ì„±ì</span>
                    {% else %}
                      <span style="margin-right: 8px;"></span>
                    {% endif %}
                    <span style="font-size: 12px; color: #868e96;">{{ reply.created_at|date:"Y-m-d H:i" }}</span>
                  </div>

                  {% if request.user == reply.author or request.user.role == 'manager' %}
                    <a href="{% url 'board:comment_delete' reply.pk %}"
                       onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                       style="font-size: 12px; color: #dc3545; text-decoration: none;">
                       ì‚­ì œ
                    </a>
                  {% endif %}
                </div>
                <div style="white-space: pre-wrap; color: #495057; font-size: 14px;">{{ reply.comment_content }}</div>
              </li>
              {% endif %}
            {% endfor %}

            {% endif %} {% endif %} {% empty %}
            <li style="padding: 20px 0; text-align: center; color: #868e96;">ì‘ì„±ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</li>
          {% endfor %}
        </ul>

        {% if request.user.is_authenticated %}
        <form action="{% url 'board:comment_create' post.post_id %}" method="post" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
          {% csrf_token %}
          <div style="display: flex; gap: 10px;">
            <textarea name="comment_content" required placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”." style="flex: 1; height: 60px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; resize: none;"></textarea>
            <button type="submit" style="width: 80px; background-color: #495057; color: white; border: none; border-radius: 5px; cursor: pointer;">ë“±ë¡</button>
          </div>
        </form>
        {% else %}
        <div style="background: #f8f9fa; padding: 20px; text-align: center; border-radius: 8px; color: #868e96;">
          ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="{% url 'user:login' %}" style="color: #0d6efd; text-decoration: underline;">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </div>
        {% endif %}
      </section>

    </article>

  </div>
</main>

<script>
  function toggleReplyForm(commentId) {
    var form = document.getElementById('reply-form-' + commentId);
    if (form.style.display === 'none') {
      form.style.display = 'block';
    } else {
      form.style.display = 'none';
    }
  }
</script>
{% endblock %}