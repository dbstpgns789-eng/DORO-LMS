{% extends "base.html" %}
{% load static %}

{% block title %}{{ post.post_title }} | DORO LMS{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/community_detail.css' %}">
{% endblock %}

{% block content %}
<section class="hero">
  <div class="hero-inner"></div>
</section>

<main class="card-wrap">
  <div class="card-inner">

    <article class="post-article">

      <header class="post-header">
        <h2 class="post-title">
          {% if not post.open %}
            <span class="lock-icon">ğŸ”’</span>
          {% endif %}
          {% if post.board %}
            <span class="board-badge">
              [{{ post.get_board_display|default:post.board }}]
            </span>
          {% endif %}
          {{ post.post_title }}
        </h2>
        <div class="post-meta">
          <span>ğŸ‘¤ {{ post.author.name }}</span>
          <span>ğŸ“… {{ post.created_at|date:"Yë…„ mì›” dì¼ H:i" }}</span>
          <span>ğŸ‘ï¸ ì¡°íšŒìˆ˜ {{ post.view }}</span>
        </div>
      </header>

      <div class="post-content">{{ post.content }}</div>

      <div class="post-footer">
        <a href="{% url 'board:community_list' %}" class="btn-list">â† ëª©ë¡ìœ¼ë¡œ</a>
        <div class="post-actions">
          {% if request.user == post.author %}
          <a href="{% url 'board:community_update' post.post_id %}" class="btn-edit">âœï¸ ìˆ˜ì •</a>
          {% endif %}
          {% if request.user == post.author or request.user.role == 'manager' %}
          <a href="{% url 'board:community_delete' post.post_id %}" class="btn-delete">ğŸ—‘ï¸ ì‚­ì œ</a>
          {% endif %}
        </div>
      </div>

      <section class="comment-section">
        <h3 class="comment-title">
          ëŒ“ê¸€ <span class="comment-count">{{ active_count }}</span>
        </h3>

        <ul class="comment-list">
          {% for comment in post.communitycomment_set.all %}
            {% if not comment.parent %}
            {% if not comment.is_deleted or comment.has_active_replies %}

            <li class="comment-item">
              {% if comment.is_deleted %}
                <div class="comment-deleted">ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤.</div>
              {% else %}
                <div class="comment-header">
                  <div>
                    <strong class="comment-author">{{ comment.author.name }}</strong>
                    {% if comment.author == post.author %}
                      <span class="author-badge">ì‘ì„±ì</span>
                    {% else %}
                      <span style="margin-right: 8px;"></span>
                    {% endif %}
                    <span class="comment-date">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
                  </div>

                  <div class="comment-actions">
                    {% if request.user.is_authenticated %}
                    <button onclick="toggleReplyForm('{{ comment.pk }}')" class="btn-reply-toggle">ë‹µê¸€</button>
                    {% endif %}
                    {% if request.user == comment.author or request.user.role == 'manager' %}
                      <a href="{% url 'board:comment_delete' comment.pk %}"
                         onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                         class="btn-comment-delete">ì‚­ì œ</a>
                    {% endif %}
                  </div>
                </div>

                <div class="comment-body">{{ comment.comment_content }}</div>

                <div id="reply-form-{{ comment.pk }}" class="reply-form-container">
                  <form action="{% url 'board:comment_create' post.post_id %}" method="post" class="reply-form">
                    {% csrf_token %}
                    <input type="hidden" name="parent_id" value="{{ comment.pk }}">
                    <textarea name="comment_content" required placeholder="ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." rows="2" class="reply-textarea"></textarea>
                    <button type="submit" class="btn-reply-submit">ë“±ë¡</button>
                  </form>
                </div>
              {% endif %}
            </li>

            {% for reply in comment.replies.all %}
              {% if not reply.is_deleted %}
              <li class="reply-item">
                <div class="comment-header">
                  <div style="display: flex; align-items: center;">
                    <span class="reply-icon">â†³</span>
                    <strong class="comment-author">{{ reply.author.name }}</strong>
                    {% if reply.author == post.author %}
                      <span class="author-badge">ì‘ì„±ì</span>
                    {% else %}
                      <span style="margin-right: 8px;"></span>
                    {% endif %}
                    <span class="comment-date">{{ reply.created_at|date:"Y-m-d H:i" }}</span>
                  </div>

                  {% if request.user == reply.author or request.user.role == 'manager' %}
                    <a href="{% url 'board:comment_delete' reply.pk %}"
                       onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                       class="btn-comment-delete">ì‚­ì œ</a>
                  {% endif %}
                </div>
                <div class="comment-body">{{ reply.comment_content }}</div>
              </li>
              {% endif %}
            {% endfor %}

            {% endif %} {% endif %} {% empty %}
            <li class="empty-comments">ì‘ì„±ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</li>
          {% endfor %}
        </ul>

        {% if request.user.is_authenticated %}
        <form action="{% url 'board:comment_create' post.post_id %}" method="post" class="comment-create-form">
          {% csrf_token %}
          <div class="comment-create-inner">
            <textarea name="comment_content" required placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”." class="comment-textarea"></textarea>
            <button type="submit" class="btn-comment-submit">ë“±ë¡</button>
          </div>
        </form>
        {% else %}
        <div class="login-required">
          ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="{% url 'user:login' %}" class="link-login">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </div>
        {% endif %}
      </section>

    </article>

  </div>
</main>

<script>
  function toggleReplyForm(commentId) {
    var form = document.getElementById('reply-form-' + commentId);
    if (form.style.display === 'none' || form.style.display === '') {
      form.style.display = 'block';
    } else {
      form.style.display = 'none';
    }
  }
</script>
{% endblock %}