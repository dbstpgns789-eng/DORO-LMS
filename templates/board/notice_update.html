{% extends "base.html" %}
{% load static %}

{% block title %}공지 수정 | DORO LMS{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/notice_update.css' %}">
{% endblock %}

{% block content %}
<div id="canvas" class="notice-update">

  <section class="hero hero--notice">
    <div class="hero__inner">
      <h1 class="hero__title">공지사항</h1>
      <p class="hero__subtitle">
        등록된 공지 사항의 내용을 수정합니다.
      </p>
    </div>
  </section>

  <main class="notice-update-layout" role="main" aria-label="공지 수정">
    <section class="card notice-update-card">

      <header class="notice-update-card__header">
        <h2 class="notice-update-card__title">공지 수정</h2>
      </header>

      <form method="post" class="notice-update-form">
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div style="margin-bottom:12px; color:#DC2626; font-size:13px;">
            {% for err in form.non_field_errors %}
              <div>{{ err }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <div class="notice-update-row">

          <div class="field-group">
            <label for="notice_type" class="field-label">분류</label>
            <select id="notice_type" name="notice_type" class="field-control field-select">
              <option value="NOTICE" {% if form.instance.notice_type == 'NOTICE' %}selected{% endif %}>공지</option>
              <option value="MAINT" {% if form.instance.notice_type == 'MAINT' %}selected{% endif %}>점검</option>
            </select>
          </div>

          <div class="field-group">
            <label for="notice_target" class="field-label">대상</label>
            <select id="notice_target" name="target" class="field-control field-select">
              <option value="ALL" {% if form.instance.target == 'ALL' %}selected{% endif %}>전체</option>
              <option value="STUDENT" {% if form.instance.target == 'STUDENT' %}selected{% endif %}>학생</option>
              <option value="TEACHER" {% if form.instance.target == 'TEACHER' %}selected{% endif %}>강사</option>
            </select>
          </div>

          <div class="field-group field-group--grow">
            <label for="notice_title" class="field-label">{{ form.title.label }}</label>
            <input
              id="notice_title"
              name="{{ form.title.name }}"
              type="text"
              class="field-control field-input"
              placeholder="공지 제목을 입력하세요."
              value="{{ form.title.value|default_if_none:'' }}"
            >
            {% if form.title.errors %}
              <div style="color:#DC2626; font-size:12px; margin-top:4px;">
                {% for err in form.title.errors %}{{ err }}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>

        <div class="editor-shell">
          <div class="editor-toolbar">
            <div class="editor-toolbar__left" aria-hidden="true">
              <img src="{% static 'img/editor_toolbar_sample.png' %}"
                   alt=""
                   class="editor-toolbar__img">
            </div>
          </div>

          <textarea
            id="notice_content"
            name="{{ form.content.name }}"
            class="editor-body"
            placeholder="공지 내용을 입력하세요.">{{ form.content.value|default_if_none:'' }}</textarea>
        </div>
        {% if form.content.errors %}
          <div style="color:#DC2626; font-size:12px; margin-top:4px;">
            {% for err in form.content.errors %}{{ err }}{% endfor %}
          </div>
        {% endif %}

        <div style="margin-top:12px;">
          <label style="display:flex; align-items:center; gap:8px; font-size:14px;">
            <input type="checkbox"
                   name="is_pinned"
                   {% if form.instance.is_pinned %}checked{% endif %}>
            <span>상단 고정</span>
          </label>
          {% if form.is_pinned.errors %}
            <div style="color:#DC2626; font-size:12px; margin-top:4px;">
              {% for err in form.is_pinned.errors %}{{ err }}{% endfor %}
            </div>
          {% endif %}
        </div>

        <div class="notice-update-footer">
          <a href="{% url 'board:notice_detail' notice.notice_id %}"
             class="btn-secondary notice-update__cancel"
             style="text-decoration: none;">
            취소
          </a>
          <button type="submit" class="btn-primary notice-update__submit">
            수정 완료
          </button>
        </div>
      </form>
    </section>

    <div class="update-toast" id="update-toast" aria-hidden="true">
      <div class="update-toast__box">
        <div class="update-toast__icon-circle">
          <span class="update-toast__icon-mark">!</span>
        </div>
        <p class="update-toast__message">수정 하시겠습니까?</p>
        <button type="button"
                class="update-toast__btn"
                id="update-toast-confirm">
          확인
        </button>
      </div>
    </div>

  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.querySelector('.notice-update-form');
      const submitBtn = document.querySelector('.notice-update__submit');
      const toast = document.getElementById('update-toast');
      const toastConfirm = document.getElementById('update-toast-confirm');

      if (!form || !submitBtn || !toast || !toastConfirm) return;

      // 1. Submit 버튼 클릭 시 팝업 띄우기
      submitBtn.addEventListener('click', function (e) {
        e.preventDefault();
        toast.classList.add('is-visible');
        toast.setAttribute('aria-hidden', 'false');
      });

      // 2. 확인 버튼 클릭 시 실제 전송
      toastConfirm.addEventListener('click', function () {
        toast.classList.remove('is-visible');
        toast.setAttribute('aria-hidden', 'true');
        form.submit();
      });
    });
  </script>

</div>
{% endblock %}